{"version":3,"file":"stuttered-pipe.js","names":["events","require","StutteredPipe","_events$EventEmitter","_inherits","_super","_createSuper","readable","writable","options","_this","_classCallCheck","call","bufSize","autoPause","paused","eod","scheduled","on","end","resume","_schedule","_createClass","key","value","pause","clearImmediate","_this2","setImmediate","data","read","length","write","EventEmitter","module","exports"],"sources":["../../../lib/utils/stuttered-pipe.js"],"sourcesContent":["const events = require('events');\n\n// =============================================================================\n// StutteredPipe - Used to slow down streaming so GC can get a look in\nclass StutteredPipe extends events.EventEmitter {\n  constructor(readable, writable, options) {\n    super();\n\n    options = options || {};\n\n    this.readable = readable;\n    this.writable = writable;\n    this.bufSize = options.bufSize || 16384;\n    this.autoPause = options.autoPause || false;\n\n    this.paused = false;\n    this.eod = false;\n    this.scheduled = null;\n\n    readable.on('end', () => {\n      this.eod = true;\n      writable.end();\n    });\n\n    // need to have some way to communicate speed of stream\n    // back from the consumer\n    readable.on('readable', () => {\n      if (!this.paused) {\n        this.resume();\n      }\n    });\n    this._schedule();\n  }\n\n  pause() {\n    this.paused = true;\n  }\n\n  resume() {\n    if (!this.eod) {\n      if (this.scheduled !== null) {\n        clearImmediate(this.scheduled);\n      }\n      this._schedule();\n    }\n  }\n\n  _schedule() {\n    this.scheduled = setImmediate(() => {\n      this.scheduled = null;\n      if (!this.eod && !this.paused) {\n        const data = this.readable.read(this.bufSize);\n        if (data && data.length) {\n          this.writable.write(data);\n\n          if (!this.paused && !this.autoPause) {\n            this._schedule();\n          }\n        } else if (!this.paused) {\n          this._schedule();\n        }\n      }\n    });\n  }\n}\n\nmodule.exports = StutteredPipe;\n"],"mappings":";;;;;;;;;;;;;;;AAAA,IAAMA,MAAM,GAAGC,OAAO,CAAC,QAAQ,CAAC;;AAEhC;AACA;AAAA,IACMC,aAAa,0BAAAC,oBAAA;EAAAC,SAAA,CAAAF,aAAA,EAAAC,oBAAA;EAAA,IAAAE,MAAA,GAAAC,YAAA,CAAAJ,aAAA;EACjB,SAAAA,cAAYK,QAAQ,EAAEC,QAAQ,EAAEC,OAAO,EAAE;IAAA,IAAAC,KAAA;IAAAC,eAAA,OAAAT,aAAA;IACvCQ,KAAA,GAAAL,MAAA,CAAAO,IAAA;IAEAH,OAAO,GAAGA,OAAO,IAAI,CAAC,CAAC;IAEvBC,KAAA,CAAKH,QAAQ,GAAGA,QAAQ;IACxBG,KAAA,CAAKF,QAAQ,GAAGA,QAAQ;IACxBE,KAAA,CAAKG,OAAO,GAAGJ,OAAO,CAACI,OAAO,IAAI,KAAK;IACvCH,KAAA,CAAKI,SAAS,GAAGL,OAAO,CAACK,SAAS,IAAI,KAAK;IAE3CJ,KAAA,CAAKK,MAAM,GAAG,KAAK;IACnBL,KAAA,CAAKM,GAAG,GAAG,KAAK;IAChBN,KAAA,CAAKO,SAAS,GAAG,IAAI;IAErBV,QAAQ,CAACW,EAAE,CAAC,KAAK,EAAE,YAAM;MACvBR,KAAA,CAAKM,GAAG,GAAG,IAAI;MACfR,QAAQ,CAACW,GAAG,CAAC,CAAC;IAChB,CAAC,CAAC;;IAEF;IACA;IACAZ,QAAQ,CAACW,EAAE,CAAC,UAAU,EAAE,YAAM;MAC5B,IAAI,CAACR,KAAA,CAAKK,MAAM,EAAE;QAChBL,KAAA,CAAKU,MAAM,CAAC,CAAC;MACf;IACF,CAAC,CAAC;IACFV,KAAA,CAAKW,SAAS,CAAC,CAAC;IAAC,OAAAX,KAAA;EACnB;EAACY,YAAA,CAAApB,aAAA;IAAAqB,GAAA;IAAAC,KAAA,EAED,SAAAC,MAAA,EAAQ;MACN,IAAI,CAACV,MAAM,GAAG,IAAI;IACpB;EAAC;IAAAQ,GAAA;IAAAC,KAAA,EAED,SAAAJ,OAAA,EAAS;MACP,IAAI,CAAC,IAAI,CAACJ,GAAG,EAAE;QACb,IAAI,IAAI,CAACC,SAAS,KAAK,IAAI,EAAE;UAC3BS,cAAc,CAAC,IAAI,CAACT,SAAS,CAAC;QAChC;QACA,IAAI,CAACI,SAAS,CAAC,CAAC;MAClB;IACF;EAAC;IAAAE,GAAA;IAAAC,KAAA,EAED,SAAAH,UAAA,EAAY;MAAA,IAAAM,MAAA;MACV,IAAI,CAACV,SAAS,GAAGW,YAAY,CAAC,YAAM;QAClCD,MAAI,CAACV,SAAS,GAAG,IAAI;QACrB,IAAI,CAACU,MAAI,CAACX,GAAG,IAAI,CAACW,MAAI,CAACZ,MAAM,EAAE;UAC7B,IAAMc,IAAI,GAAGF,MAAI,CAACpB,QAAQ,CAACuB,IAAI,CAACH,MAAI,CAACd,OAAO,CAAC;UAC7C,IAAIgB,IAAI,IAAIA,IAAI,CAACE,MAAM,EAAE;YACvBJ,MAAI,CAACnB,QAAQ,CAACwB,KAAK,CAACH,IAAI,CAAC;YAEzB,IAAI,CAACF,MAAI,CAACZ,MAAM,IAAI,CAACY,MAAI,CAACb,SAAS,EAAE;cACnCa,MAAI,CAACN,SAAS,CAAC,CAAC;YAClB;UACF,CAAC,MAAM,IAAI,CAACM,MAAI,CAACZ,MAAM,EAAE;YACvBY,MAAI,CAACN,SAAS,CAAC,CAAC;UAClB;QACF;MACF,CAAC,CAAC;IACJ;EAAC;EAAA,OAAAnB,aAAA;AAAA,EA3DyBF,MAAM,CAACiC,YAAY;AA8D/CC,MAAM,CAACC,OAAO,GAAGjC,aAAa"}